# 놀이 세션 분석 시스템 가이드

## 📋 시스템 개요

이 시스템은 교사-아동 놀이 세션 데이터를 분석하여 **3가지 레포트**와 **방문일지**를 자동 생성합니다.

### 생성되는 문서

1. **부모용 레포트** - 이해하기 쉽고 긍정적인 피드백 중심
2. **선생님용 레포트** - 교육적 인사이트와 발달 영역별 관찰
3. **방문일지** - 공식 기록용 관찰 일지
4. **회사용 레포트** - 상세한 데이터 분석 및 품질 지표

---

## 🎯 분석 지표

### 현재 추출 가능한 지표

| 지표명 | 설명 | 활용 |
|--------|------|------|
| **아동발화비율** | 전체 발화 중 아동 발화 비율 | 아동 주도성 평가 |
| **발화양** | 아동의 총 발화 수 및 단어 수 | 언어 표현 활동성 |
| **주제지속도** | 평균 연속 발화 수 | 집중력 및 몰입도 |
| **맥락전환도** | 주제가 바뀌는 빈도 | 탐색적 vs 집중적 놀이 |
| **문제해결발화** | '왜', '어떻게' 등 문제해결 관련 발화 | 인지 발달 수준 |
| **긍정/부정비율** | 긍정적/부정적 정서 표현 비율 | 정서 안정성 |
| **주요정서단어** | 자주 사용하는 정서 단어 | 정서적 특성 파악 |
| **주요토픽** | 빈도 높은 키워드 | 관심사 및 놀이 주제 |

---

## 🚀 사용 방법

### 1. 환경 설정

```bash
# 의존성 설치 (필요한 경우)
pip install numpy

# 또는 requirements.txt가 있다면
pip install -r requirements.txt
```

### 2. 단일 세션 분석

```bash
# 방법 1: 기본 실행 (테스트용)
python3 run_full_analysis.py

# 방법 2: 특정 세션 지정
python3 run_full_analysis.py --session /path/to/session_folder
```

**예시:**
```bash
python3 run_full_analysis.py \
  --session raw_data/20251017-이민정교사-김준우-만4세-02_00_48-65kbps_mono
```

### 3. 일괄 처리 (배치 모드)

```bash
# raw_data 폴더의 모든 세션 처리
python3 run_full_analysis.py --batch

# 처리할 세션 수 제한 (처음 2개만)
python3 run_full_analysis.py --batch --limit 2

# 커스텀 경로 지정
python3 run_full_analysis.py --batch \
  --raw-data-dir /path/to/raw_data \
  --output-dir /path/to/output
```

### 4. 분석만 실행 (레포트 생성 제외)

```bash
python3 enhanced_analysis.py
```

---

## 📁 디렉토리 구조

```
care-intell/
├── raw_data/                          # 원본 데이터
│   └── [세션폴더]/
│       ├── vtt/                       # 대화 텍스트 파일
│       ├── ai_response/               # AI 분석 조각
│       └── feature/                   # 음성 특징 데이터
│
├── analysis_results/                  # 분석 결과 JSON
│   └── [세션명]_enhanced_analysis.json
│
├── reports/                           # 생성된 레포트
│   ├── [세션명]_parent_report.txt    # 부모용
│   ├── [세션명]_teacher_report.txt   # 선생님용
│   ├── [세션명]_visit_journal.txt    # 방문일지
│   └── [세션명]_company_report.txt   # 회사용
│
├── enhanced_analysis.py               # 분석 엔진
├── report_generator.py                # 레포트 생성기
└── run_full_analysis.py               # 통합 실행 스크립트
```

---

## 📊 레포트 상세 설명

### 1. 부모용 레포트

**특징:**
- 쉬운 언어와 긍정적 표현
- 이모지를 활용한 시각적 전달
- 가정 연계 활동 제안
- 아이의 강점 강조

**주요 섹션:**
- 📋 기본 정보
- 🎯 오늘의 놀이 활동
- 💬 의사소통 발달
- 🧠 사고력 발달
- 😊 정서 발달
- 🎨 집중력과 몰입
- ✨ 특별히 관찰된 점
- 🏠 가정에서 함께 해보세요

### 2. 선생님용 레포트

**특징:**
- 교육학적 용어 사용
- 발달 영역별 상세 분석
- 교육적 제언 포함
- 다음 세션 계획 제시

**주요 섹션:**
- 📊 발달 영역별 상세 분석
  - 언어 발달
  - 인지 발달
  - 사회정서 발달
  - 놀이 특성
- 시간대별 참여 패턴
- 📝 교육적 제언
- 📅 다음 세션 계획

### 3. 방문일지

**특징:**
- 공식 문서 형식
- 누리과정 5개 영역 기준
- 객관적 관찰 기록
- 서명란 포함

**주요 섹션:**
- 기본 정보
- 놀이 환경
- 놀이 내용 및 활동
- 발달 영역별 관찰 내용 (5개 영역)
- 특이 사항 및 종합 의견
- 향후 지도 방향

### 4. 회사용 레포트

**특징:**
- 모든 정량 지표 포함
- 시간대별 상세 분석
- 품질 점수화 (0-100점)
- 개선 권장 사항

**주요 섹션:**
- 세션 메타데이터
- 핵심 지표 요약 (KPI)
- 상세 언어 분석
- 인지 발달 분석
- 정서 발달 분석
- 주제 및 관심사 분석
- 시간대별 상세 분석
- 교육 품질 지표 (점수화)
- 데이터 기반 개선 권장 사항

---

## 🔍 샘플 결과

### 주요 지표 예시 (김준우 아동, 만4세)

```
📊 주요 지표 요약:
  • 아동 발화 비율: 52.7%
  • 아동 발화 수: 3093회
  • 평균 발화 길이: 3.5 단어
  • 문제해결 발화: 92회
  • 주제 지속도: 3.81
  • 긍정/부정 비율: 0.57
```

### 품질 점수 예시

```
교육 품질 지표:
  아동 주도성    [████████████████████████████████████████] 100.0점
  언어 표현력    [████████████████████████████████        ]  69.5점
  인지 참여도    [████████████████████████████████████████] 100.0점
  정서 안정성    [█████████████████████████              ]  57.3점
  집중도         [████████████████████████████████████████] 100.0점
  --------------------------------------------------------
  종합 점수      [████████████████████████████████████    ]  85.4점
  
종합 등급: A+ (매우 우수)
```

---

## 🎬 에피소드 & 대화 인용 정확도 원칙

보고서 신뢰도를 위해, **에피소드와 대화 인용은 다음 원칙**을 따릅니다.

### 1. 직접 인용(따옴표) 규칙

- **반드시 VTT 원문에서 그대로 복사**해서 사용합니다.
- 말투를 다듬거나, 비슷한 말로 바꾸거나, 새로운 문장을 만들어내지 않습니다.
- 인용이 어려운 경우에는:
  - 따옴표(“ ”)를 쓰지 않고, **요약 서술**로만 표현합니다.
  - 예: `준우가 주사위와 비슷한 단어를 헷갈리는 장면이 있었고, 선생님이 실제 물건을 보여주며 정정해 주었습니다.`

### 2. 화자·역할 해석 안전장치

- 누가 먼저 말했는지, 누가 질문/응답/공감을 했는지 **역할을 뒤집지 않습니다.**
- LLM 프롬프트에 다음과 같이 명시합니다:
  - “대사는 반드시 주어진 대본에서 그대로 복사해서 사용하세요.”
  - “선생님/아동이 한 말을 서로 바꾸어 해석하지 마세요.”
  - “어느 쪽이 먼저 말했는지 확실하지 않다면, ‘~처럼 보입니다’ 같은 추측 표현은 쓰지 말고 사실만 서술하세요.”

### 3. 좋은 상호작용 패턴(김준우 세션에서 나온 인사이트)

사람이 직접 분석했을 때 **교사 피드백에 매우 유용했던 패턴**들을, 이후 자동 분석의 핵심 포인트로 삼습니다.

- **(1) 아이의 “아니야!” 신호를 긍정적으로 보기**
  - 아이가 “아니야!”, “그렇게 말하는 거 아니야”라고 할 때, **자기 방식과 기준이 있다는 건강한 싸인**으로 해석합니다.
  - 교사용 레포트에서는 “아이가 자신의 놀이 방식을 분명히 표현한 순간”으로 칭찬 포인트로 기록합니다.

- **(2) 아이 말을 그대로 따라 반영해 주는 상호작용**
  - 예: “출동출동~”, “긴급상황!”, “삐뽀삐뽀”처럼 아이가 한 말을 선생님이 **그대로 따라 말하며 놀이에 합류**하는 장면.
  - 이는 **정서적 조율(튜닝)**과 **공감적 참여**의 좋은 예로, 교사용 레포트의 “좋았던 상호작용 예시”에 반드시 포함합니다.

- **(3) 선생님의 말 속도·비율이 빠른 편인 경우**
  - 이 세션의 선생님은 또래보다 **조금 빠른 템포**로 상호작용하는 편이었습니다.
  - “언어가 느린 아이”와의 상호작용에서는 **말 속도와 설명 길이를 더 줄여야 한다**는 코멘트로 연결합니다.
  - 이는 `Pace & Space` 신호등과 함께, **주의 환기 포인트**로 정리합니다.

- **(4) 아이의 “왜~?” 질문**
  - 예: “왜 허수아비는 안 입었어요?” 같은 질문은 **인과·이유·호기심**이 살아 있는 발화로 봅니다.
  - 인지/언어 발달에서 **“질문 생성 능력”**의 긍정적 지표로 기록하고, 좋은 예시는 부모·선생님 모두에게 보여줍니다.

- **(5) 함께 노래 부르기**
  - 선생님과 아이가 함께 노래를 부르는 장면은 **정서적 친밀감과 공동 주의(joint attention)**가 잘 나타나는 순간입니다.
  - 교사용 레포트에서는 “관계 형성에 특히 좋았던 상호작용”으로 별도 하이라이트합니다.

- **(6) “잘한다”, “최고다” 반복 사용**
  - 선생님의 “잘한다”, “최고다” 등 칭찬이 **두드러지게 많은 경우**,  
    - 양적으로는 **긍정 언어 사용 빈도**로 카운트하고,
    - 질적으로는 “내용을 구체화하면 더 도움이 된다”는 피드백(예: “잘한다” → “자동차 순서를 직접 정한 게 정말 좋았어”)으로 연결합니다.

이러한 패턴들은 **교사용 레포트의 ‘teacher_strengths / praise_highlights / coaching_points’**에 직접 연결되며,  
향후 자동 분석에서도 **우선적으로 탐지·요약해야 하는 핵심 상호작용 지표**로 취급합니다.

---

## 💡 활용 팁

### 1. 데이터 준비

VTT 파일은 다음 형식이어야 합니다:

```vtt
WEBVTT

00:00:01.000 --> 00:00:05.500
[이민정 선생님] 안녕하세요, 준우야!

00:00:06.000 --> 00:00:08.500
[김준우 아이] 안녕하세요!
```

**중요:**
- 화자 표시: `[이름 선생님]` 또는 `[이름 아이]`
- 선생님/교사 키워드 포함 시 교사로 분류
- 그 외는 아동으로 분류

### 2. 분석 커스터마이징

`enhanced_analysis.py`의 키워드 사전을 수정하여 감정 분석을 조정할 수 있습니다:

```python
self.positive_words = ['좋아', '재밌', '신나', ...]
self.negative_words = ['싫어', '안돼', '아니', ...]
self.problem_solving_words = ['어떻게', '왜', '방법', ...]
```

### 3. 레포트 템플릿 수정

각 레포트 생성 함수를 수정하여 포맷이나 내용을 변경할 수 있습니다:

- `generate_parent_report()` - 부모용
- `generate_teacher_report()` - 선생님용
- `generate_visit_journal()` - 방문일지
- `generate_company_report()` - 회사용

---

## 🔧 문제 해결

### Q1: "command not found: python" 오류

**해결:** `python3` 사용
```bash
python3 run_full_analysis.py
```

### Q2: VTT 파일이 인식되지 않음

**확인 사항:**
- 파일 확장자가 `.vtt`인지 확인
- 파일이 `vtt/` 폴더 안에 있는지 확인
- 화자 표시 형식이 `[이름]`인지 확인

### Q3: 분석 결과가 이상함

**체크리스트:**
- VTT 파일의 타임스탬프 형식 확인
- 화자 구분이 정확한지 확인
- 세션 시간이 너무 짧지 않은지 확인 (최소 5분 권장)

---

## 🚦 상호작용 신호등 (Teacher Interaction Traffic Lights)

선생님 레포트에서는 복잡한 수치 대신, **3단계 신호등(Green / Yellow / Red)**으로 상호작용 상태를 한눈에 볼 수 있도록 설계합니다.  
이 신호등은 모두 아래와 같이 **명시적인 수식과 구간 기준**에 따라 계산됩니다.

### 1. 말의 균형 (Talk Balance)

- 사용 지표: `child_utterance_ratio` (0~100%)

```text
c = child_utterance_ratio

Green : 40 <= c <= 60
Yellow: 30 <= c < 40 또는 60 < c <= 70
Red   : c < 30 또는 c > 70
```

- 해석 예시:
  - Green: “아동과 선생님 발화 비율이 40–60% 범위로, 서로 말을 주고받는 균형이 좋습니다.”
  - Yellow: “한쪽이 조금 더 많이 말하는 편입니다. 아이가 말할 수 있는 틈을 조금 더 열어 주면 좋습니다.”
  - Red: “한쪽이 대부분 말하고 있어, 아이의 자발적 발화 기회가 부족했을 수 있습니다.”

### 2. 정서 톤 (Emotional Tone)

- 사용 지표:

```text
P_t = teacher_positive_utterances / (teacher_positive_utterances + teacher_negative_utterances)
N_c = child_negative_utterances / (child_positive_utterances + child_negative_utterances)
```

```text
Green : P_t >= 0.75  그리고  N_c <= 0.40
Yellow: 0.5 <= P_t < 0.75  또는  0.40 < N_c <= 0.60
Red   : P_t < 0.5   또는   N_c > 0.60
```

- 해석 예시:
  - Green: “선생님의 긍정 표현이 충분하고, 아이의 부정 표현도 과도하지 않은 편입니다.”
  - Yellow: “격려와 지적 표현이 비슷한 수준입니다. 같은 내용을 긍정 언어로 바꿔보면 좋습니다.”
  - Red: “지적/부정 표현 비율이 높거나, 아이의 부정 표현이 잦아 정서적 부담이 되었을 수 있습니다.”

### 3. 속도와 여유 (Pace & Space)

- 사용 지표:
  - `speech_rate_frames` (말하기 속도)
  - `teacher_avg_utterance_length` (선생님 평균 발화 길이, 단어 수 기준)

```text
말하기 속도 구간 (speech_rate_frames)
  느림 : < 35
  보통 : 35 ~ 50
  빠름 : > 50

발화 길이 구간 (teacher_avg_utterance_length)
  짧음 : < 4
  적절 : 4 ~ 10
  김   : > 10

판정 규칙:
  Green : 속도 = 보통  그리고  길이 = 적절
  Yellow: (속도 = 빠름  그리고  길이 = 적절)
          또는 (속도 = 보통  그리고  길이 = 김)
  Red   : (속도 = 빠름  그리고  길이 = 김)
          또는 (속도 = 느림  그리고  길이 = 김)
```

- 해석 예시:
  - Green: “설명 속도와 길이가 적절해, 아이가 생각하고 말할 수 있는 여유가 충분했습니다.”
  - Yellow: “말 속도나 설명 길이가 약간 빠르거나 길어, 중요한 내용은 한 번 더 짧게 나누어 말해주면 좋습니다.”
  - Red: “설명이 빠르고 길어, 아이가 듣기만 하는 시간이 길었을 수 있습니다.”

### 4. 에너지와 몰입 (Energy & Engagement)

- 사용 지표:
  - `rms_mean` (평균 음압, 볼륨)
  - `f0_range` (기본 주파수 범위, 음높이 변화폭)

```text
볼륨 구간 (rms_mean)
  낮음 : < 0.02
  적절 : 0.02 ~ 0.06
  높음 : > 0.06

음높이 변화 구간 (f0_range, Hz)
  너무 좁음 : < 150
  적당     : 150 ~ 1200
  너무 넓음 : > 1200

판정 규칙:
  Green : 볼륨 = 적절  그리고  음높이 변화 = 적당
  Yellow: (볼륨 = 낮음 또는 높음) 그리고 음높이 변화 = 적당
          또는 (음높이 변화 = 너무 좁음)
  Red   : (볼륨 = 높음  그리고  음높이 변화 = 너무 넓음)
          또는 (볼륨 = 낮음  그리고  음높이 변화 = 너무 좁음)
```

- 해석 예시:
  - Green: “에너지가 적절하고, 목소리 높낮이도 풍부해 아이 몰입을 이끄는 데 도움이 되었습니다.”
  - Yellow: “에너지가 다소 낮거나 높아, 상황에 따라 조금 더 올리거나 낮춰도 좋겠습니다.”
  - Red: “지속적으로 지나치게 높거나 낮은 에너지로, 아이에게 피로감을 줄 수 있는 수준일 수 있습니다.”

### 5. 김준우 세션 예시 결과

`20251017-이민정교사-김준우-만4세` 세션에 위 기준을 적용하면:

- 말의 균형 (Talk Balance):  
  - `child_utterance_ratio = 52%` → **Green**
- 정서 톤 (Emotional Tone):  
  - `P_t = 85 / (85 + 15) = 0.85`  
  - `N_c = 25 / (40 + 25) ≈ 0.38` → **Green**
- 속도와 여유 (Pace & Space):  
  - `speech_rate_frames = 43.07` → “보통”  
  - `teacher_avg_utterance_length = 6.5` → “적절” → **Green**
- 에너지와 몰입 (Energy & Engagement):  
  - `rms_mean = 0.0346` → “적절”  
  - `f0_range ≈ 2027.6 Hz` → “너무 넓음” → **Yellow**

따라서 이 세션의 상호작용 신호등 요약은:

```text
말의 균형   : Green
정서 톤     : Green
속도와 여유 : Green
에너지와 몰입: Yellow
```

---

## 📈 향후 개선 계획

### 예정된 기능

- [ ] 여러 세션 비교 분석
- [ ] 발달 추이 그래프
- [ ] PDF 레포트 생성
- [ ] 대시보드 UI
- [ ] API 서버 구축
- [ ] 음성 특징 분석 통합 (피치, 템포 등)

### 추가 지표 후보

- 턴테이킹 패턴 (대화 주고받기)
- 어휘 다양성 (TTR)
- 문장 복잡도
- 공감적 반응 빈도
- 갈등 해결 패턴

---

## 📞 지원

문제가 발생하거나 제안 사항이 있으면 이슈를 등록해주세요.

---

**마지막 업데이트:** 2025년 11월 15일

